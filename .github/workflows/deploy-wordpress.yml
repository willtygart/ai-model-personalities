name: Deploy WordPress Theme to TygartMedia

on:
  push:
      branches: [ main ]
          paths:
                - 'wordpress/**'
                  pull_request:
                      branches: [ main ]
                          paths:
                                - 'wordpress/**'
                                  workflow_dispatch:

                                  env:
                                    WORDPRESS_SITE: wordpress.tygartmedia.com

                                    jobs:
                                      test:
                                          runs-on: ubuntu-latest
                                              name: Test WordPress Code
                                                  steps:
                                                        - name: Checkout Repository
                                                                uses: actions/checkout@v4

                                                                              - name: Setup PHP
                                                                                      uses: shivammathur/setup-php@v2
                                                                                              with:
                                                                                                        php-version: '8.1'
                                                                                                                  extensions: mbstring, intl, gd, xml, zip
                                                                                                                            
                                                                                                                                  - name: Validate PHP Syntax
                                                                                                                                          run: |
                                                                                                                                                    echo " Validating WordPress theme files..."
                                                                                                                                                              find wordpress/themes -name "*.php" -exec php -l {} \; || exit 1
                                                                                                                                                                        echo " PHP syntax validation passed"
                                                                                                                                                                                  
                                                                                                                                                                                        - name: Security Check
                                                                                                                                                                                                run: |
                                                                                                                                                                                                          echo " Running security checks..."
                                                                                                                                                                                                                    if grep -r "eval(" --include="*.php" wordpress/; then
                                                                                                                                                                                                                                echo " Security Issue: eval() found in PHP files"
                                                                                                                                                                                                                                            exit 1
                                                                                                                                                                                                                                                      fi
                                                                                                                                                                                                                                                                echo " Security checks passed"
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                  deploy-production:
                                                                                                                                                                                                                                                                      needs: test
                                                                                                                                                                                                                                                                          runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                              if: github.ref == 'refs/heads/main' && github.event_name == 'push'
                                                                                                                                                                                                                                                                                  name: Deploy to Production WordPress
                                                                                                                                                                                                                                                                                      steps:
                                                                                                                                                                                                                                                                                            - name: Checkout Repository
                                                                                                                                                                                                                                                                                                    uses: actions/checkout@v4
                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                  - name: Prepare Deployment Package
                                                                                                                                                                                                                                                                                                                          run: |
                                                                                                                                                                                                                                                                                                                                    echo " Preparing WordPress theme deployment..."
                                                                                                                                                                                                                                                                                                                                              echo " Repository: ${{ github.repository }}"
                                                                                                                                                                                                                                                                                                                                                        echo " Commit: ${{ github.sha }}"
                                                                                                                                                                                                                                                                                                                                                                  echo " Author: ${{ github.actor }}"
                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                  - name: Deploy Theme via WordPress REST API
                                                                                                                                                                                                                                                                                                                                                                                          env:
                                                                                                                                                                                                                                                                                                                                                                                                    WORDPRESS_URL: https://${{ env.WORDPRESS_SITE }}
                                                                                                                                                                                                                                                                                                                                                                                                              WP_USERNAME: ${{ secrets.WP_USERNAME }}
                                                                                                                                                                                                                                                                                                                                                                                                                        WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
                                                                                                                                                                                                                                                                                                                                                                                                                                run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                          echo " Deploying to WordPress: $WORDPRESS_URL"
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Create deployment notification post
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if [ -n "$WP_USERNAME" ] && [ -n "$WP_PASSWORD" ]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo " Creating deployment notification..."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                curl -X POST "$WORDPRESS_URL/wp-json/wp/v2/posts" \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              -u "$WP_USERNAME:$WP_PASSWORD" \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            -H "Content-Type: application/json" \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          -d '{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "title": " Theme Deployed from GitHub - '$(date '+%Y-%m-%d %H:%M')'",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "content": "<h3>WordPress Theme Successfully Deployed!</h3><p> Deployment completed successfully via GitHub Actions!</p>",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "status": "publish",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "categories": [1]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }' || echo "  Deployment post creation failed (check credentials)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              echo "  WordPress credentials not configured - skipping post creation"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Post-Deployment Health Check
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          echo " Running post-deployment checks..."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Check if WordPress site is accessible
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if curl -f -s "https://${{ env.WORDPRESS_SITE }}" > /dev/null; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo " WordPress site is accessible"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          echo " WordPress site accessibility check failed"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      exit 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  notify-success:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      needs: [test, deploy-production]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if: success()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  name: Deployment Success Notification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      steps:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - name: Success Summary
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              echo " WordPress Deployment Completed Successfully!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo " Live Site: https://${{ env.WORDPRESS_SITE }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  echo " GitHub Repository: https://github.com/${{ github.repository }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo " Deployed Commit: ${{ github.sha }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      echo " Deployed by: ${{ github.actor }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo " Deployed at: $(date)"
