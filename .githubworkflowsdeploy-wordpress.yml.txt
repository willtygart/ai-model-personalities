# Save this file as: .github/workflows/deploy-wordpress.yml

name: Deploy WordPress to Google Cloud Platform

on:
  push:
    branches: [main, wordpress-deployment]
  pull_request:
    branches: [main]

env:
  PROJECT_ID: gen-lang-client-0530082139
  PROJECT_NUMBER: 919048087487
  REGION: us-central1
  SERVICE_NAME: wordpress
  CLOUDFLARE_ZONE: tygartmedia.com

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, gd, zip, curl, mbstring, xml
          
      - name: Run PHP Lint Check
        run: find . -name "*.php" -exec php -l {} \;
      
      - name: WordPress Security Scan
        run: |
          echo "Checking WordPress security..."
          if [ -f wp-config.php ]; then
            echo "✓ wp-config.php found"
            if grep -q "WP_DEBUG.*true" wp-config.php; then
              echo "⚠️ Warning: WP_DEBUG is enabled"
            fi
          fi

  deploy-staging:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      - name: Deploy WordPress to Staging
        run: |
          echo "Deploying to staging environment..."
          gcloud run deploy $SERVICE_NAME-staging \
            --source . \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars="WORDPRESS_ENV=staging"

  deploy-production:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Build and Deploy WordPress
        run: |
          gcloud builds submit \
            --tag gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA \
            --tag gcr.io/$PROJECT_ID/$SERVICE_NAME:latest
      
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          image: gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: '--allow-unauthenticated --set-env-vars="WORDPRESS_ENV=production"'
      
      - name: Update Cloudflare DNS
        run: |
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
            --region $REGION \
            --format 'value(status.url)')
          echo "WordPress deployed to: $SERVICE_URL"
          
          if [ ! -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "Updating Cloudflare DNS..."
            # Add DNS update logic here if needed
          fi
      
      - name: Run Health Check
        run: |
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
            --region $REGION \
            --format 'value(status.url)')
          
          sleep 30
          
          if curl -f -s "$SERVICE_URL" | grep -q "WordPress"; then
            echo "✅ WordPress is running successfully"
          else
            echo "❌ WordPress health check failed"
            exit 1
          fi
      
      - name: Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ WordPress deployed successfully to production"
          else
            echo "❌ WordPress deployment failed"
          fi